# 网络连接与远程管理

## 基本概念

### IP地址与网络通信

IP地址用于唯一标识网络中的每台设备。网络通信基于TCP/IP协议，通过IP地址和端口实现主机间数据传输。

- **IPv4**：32位地址，格式如 `192.168.1.1`
- **IPv6**：128位地址，格式如 `2001:0db8:85a3::8a2e:0370:7334`，解决IPv4地址枯竭问题

### 端口

端口用于区分同一主机上的不同服务。常见端口如：
- 22：SSH
- 80：HTTP
- 443：HTTPS

---

## 网络配置与管理

### `ip` 命令

用于显示和管理网络接口、路由、IP地址等。

```bash
ip [object] [command]
```
常用用法：

- 查看所有网络接口及状态：
  ```bash
  ip addr
  ```
- 查看路由表：
  ```bash
  ip route
  ```
- 启用/禁用接口：
  ```bash
  ip link set eth0 up
  ip link set eth0 down
  ```

### `ifconfig` 命令（历史命令）

早期 Linux 网络配置常用命令，现已被 `ip` 命令取代，但部分系统仍可用。

- 查看网络接口信息：
  ```bash
  ifconfig
  ```
- 启用/禁用接口：
  ```bash
  ifconfig eth0 up
  ifconfig eth0 down
  ```

---

### `ping` 命令

用于测试主机间网络连通性。

```bash
ping [选项] 目标主机
```
常用选项：
- `-c n` 指定发送次数

示例：
```bash
ping -c 4 www.baidu.com
```

---

### `iptables` 命令详解

iptables 是 Linux 内核自带的防火墙工具，用于设置数据包过滤和网络地址转换规则。它通过“表（table）”和“链（chain）”来管理规则。

#### 基本结构

- **表（table）**：常用有 filter（默认，数据包过滤）、nat（网络地址转换）、mangle（包修改）、raw（特殊处理）。
- **链（chain）**：每个表有若干链，常用有 INPUT（入站）、OUTPUT（出站）、FORWARD（转发）、PREROUTING、POSTROUTING。

#### 常用命令

- 查看所有规则（默认 filter 表）：
  ```bash
  sudo iptables -L -n -v
  ```
- 指定表查看（如 nat）：
  ```bash
  sudo iptables -t nat -L -n -v
  ```
- 允许指定端口（如 22/SSH）：
  ```bash
  sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
  ```
- 拒绝指定端口（如 80/HTTP）：
  ```bash
  sudo iptables -A INPUT -p tcp --dport 80 -j DROP
  ```
- 删除规则（按序号）：
  ```bash
  sudo iptables -D INPUT 1
  ```
- 设置默认策略（如全部拒绝）：
  ```bash
  sudo iptables -P INPUT DROP
  sudo iptables -P FORWARD DROP
  sudo iptables -P OUTPUT ACCEPT
  ```
- 保存规则（不同发行版命令不同）：
  ```bash
  sudo iptables-save > /etc/iptables.rules
  ```
- 恢复规则：
  ```bash
  sudo iptables-restore < /etc/iptables.rules
  ```

#### 规则说明

- `-A`：追加规则到链末尾
- `-I`：插入规则到链开头
- `-D`：删除规则
- `-p`：指定协议（tcp/udp/icmp等）
- `--dport`：目标端口
- `-s`：源地址
- `-j`：动作（ACCEPT、DROP、REJECT等）

#### 示例：只允许本地SSH和HTTP

```bash
sudo iptables -P INPUT DROP
sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

---

### `ufw` 命令

UFW（Uncomplicated Firewall）是 Ubuntu 等发行版常用的防火墙前端，简化了 iptables 配置。

```bash
ufw [命令]
```
常用操作：
- 启用/禁用防火墙：
  ```bash
  sudo ufw enable
  sudo ufw disable
  ```
- 允许/拒绝端口：
  ```bash
  sudo ufw allow 22
  sudo ufw deny 80
  ```
- 查看状态：
  ```bash
  sudo ufw status
  ```

---

### NetworkManager 及相关工具

NetworkManager 是 Linux 下常用的网络管理服务，支持有线、无线、VPN等多种连接方式。

#### nmcli

命令行管理工具。

- 查看连接：
  ```bash
  nmcli connection show
  ```
- 启用/禁用网络接口：
  ```bash
  nmcli device connect eth0
  nmcli device disconnect eth0
  ```
- 连接 Wi-Fi（示例）：
  ```bash
  nmcli device wifi list
  nmcli device wifi connect "SSID" password "yourpassword"
  ```

#### nmtui

基于文本界面的 NetworkManager 配置工具，适合初学者和服务器环境。

- 启动 nmtui：
  ```bash
  nmtui
  ```
- 可进行连接管理、激活、编辑等操作。

#### iwctl

用于管理 iwd（现代无线守护进程），在 Arch Linux 等系统初期配置 Wi-Fi 常用。

- 启动 iwctl：
  ```bash
  iwctl
  ```
- 列出设备和扫描网络：
  ```bash
  device list
  station 设备名 scan
  station 设备名 get-networks
  ```
- 连接 Wi-Fi：
  ```bash
  station 设备名 connect SSID
  ```

---

### 其他网络相关命令

#### `netstat`

用于显示网络连接、路由表、接口状态等（需安装 net-tools）。

- 查看所有监听端口和进程：
  ```bash
  netstat -tulnp
  ```
  - `-t`：TCP
  - `-u`：UDP
  - `-l`：监听状态
  - `-n`：数字显示地址和端口
  - `-p`：显示进程

#### `ss`

更现代的端口和连接查看工具，功能类似 netstat，速度更快。

- 查看所有监听端口和进程：
  ```bash
  ss -tulnp
  ```

#### `traceroute`

追踪数据包到目标主机经过的路由路径。

- 基本用法：
  ```bash
  traceroute www.baidu.com
  ```

#### `nslookup`

用于查询 DNS 记录。

- 查询域名的 IP 地址：
  ```bash
  nslookup www.baidu.com
  ```

#### `dig`

功能更强大的 DNS 查询工具。

- 查询域名的详细 DNS 信息：
  ```bash
  dig www.baidu.com
  ```

#### `curl`

命令行下的网络请求工具，支持 HTTP/HTTPS/FTP 等协议。

- 下载网页内容：
  ```bash
  curl https://www.example.com
  ```
- 下载文件并保存：
  ```bash
  curl -o file.html https://www.example.com
  ```

#### `wget`

常用的命令行下载工具，支持断点续传。

- 下载文件：
  ```bash
  wget https://www.example.com/file.zip
  ```
- 断点续传：
  ```bash
  wget -c https://www.example.com/file.zip
  ```
---

## 远程连接与文件传输

### `ssh` 命令

用于安全远程登录 Linux 服务器。

```bash
ssh [选项] [用户@]主机 [命令]
```
常用选项：
- `-p 端口号` 指定端口（默认22）

示例：
```bash
ssh user@192.168.1.100
ssh -p 2222 user@192.168.1.100
```

#### SSH 密钥认证

SSH 支持基于密钥的免密登录，提升安全性和便利性。

1. **生成密钥对（本地执行）：**
   ```bash
   ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
   ```
   按提示操作，默认会在 `~/.ssh/` 目录下生成 `id_rsa`（私钥）和 `id_rsa.pub`（公钥）。

2. **上传公钥到服务器（推荐用 ssh-copy-id）：**
   ```bash
   ssh-copy-id user@192.168.1.100
   ```
   或手动将 `~/.ssh/id_rsa.pub` 内容追加到服务器的 `~/.ssh/authorized_keys` 文件中。

3. **验证免密登录：**
   ```bash
   ssh user@192.168.1.100
   ```
   若无需输入密码即登录成功，则密钥认证配置完成。

> 建议妥善保管私钥（id_rsa），不要泄露。公钥可安全分发到多台服务器。

### `sftp` 命令

基于 SSH 的安全文件传输工具。

```bash
sftp [选项] [用户@]主机
```
常用选项：
- `-P 端口号` 指定端口（注意大写）

常用操作：
- 上传文件：
  ```bash
  put 本地文件 [远程路径]
  ```
- 下载文件：
  ```bash
  get 远程文件 [本地路径]
  ```
- 列出目录：
  ```bash
  ls
  ```
- 退出：
  ```bash
  exit
  ```

示例：
```bash
sftp -P 2222 user@192.168.1.100
sftp> put test.txt
sftp> get remote.txt
sftp> exit
```

---

> 以上命令和工具可满足 Linux 下常见的网络配置、远程管理与文件传输需求，适合日常运维和服务器管理。掌握 NetworkManager、iwctl、nmtui 等工具有助于快速配置和排查网络问题。