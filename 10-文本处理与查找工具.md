# Linux 文本处理与查找工具

## 常用文本处理工具

### grep

用于在文本中查找匹配的字符串，支持正则表达式。

```bash
grep [选项] '模式' 文件
```
常用选项：
- `-i`：忽略大小写
- `-r`：递归查找目录
- `-n`：显示行号
- `-v`：反向匹配（不包含模式的行）
- `-E`：使用扩展正则

**基本语法：**
- 匹配字符串：`grep "pattern" file`
- 匹配正则：`grep -E "正则" file`

**常见操作：**
- 只显示匹配的内容（-o）：
  ```bash
  grep -o "pattern" file.txt
  ```
- 显示匹配行及上下文（-A/-B/-C）：
  ```bash
  grep -A 2 "error" file.txt   # 匹配行及后2行
  grep -B 2 "error" file.txt   # 匹配行及前2行
  grep -C 2 "error" file.txt   # 匹配行及前后各2行
  ```

---

### sed

流编辑器，常用于文本替换、删除、插入、提取等批量处理。

```bash
sed [选项] '操作' 文件
```
常用选项：
- `-i`：直接修改文件（原地编辑）
- `-n`：只输出被处理的行

**常见操作：**
- 替换：`s/原/新/g`
- 删除行：`d`
- 插入行：`i\内容`
- 追加行：`a\内容`
- 只打印匹配行：`-n '/模式/p'`

**示例：**
```bash
sed 's/foo/bar/g' file.txt           # 全文替换
sed '/^#/d' config.conf              # 删除以#开头的行
sed -n '/error/p' /var/log/syslog    # 只打印包含error的行
sed '2i\插入内容' file.txt           # 在第2行前插入
sed '3a\追加内容' file.txt           # 在第3行后追加
```

---

### awk

强大的文本分析与处理工具，支持模式匹配和脚本编程。

```bash
awk '模式 {动作}' 文件
```
- 默认以空格分隔，`$1` 表示第1列，`$2` 表示第2列，`$0` 表示整行。
- `-F` 指定分隔符

**常见操作：**
- 打印指定列：`{print $1, $3}`
- 条件筛选：`$3 > 1000 {print $1, $3}`
- 统计/计数：`{sum += $2} END {print sum}`
- 字符串处理：`length($1)>5 {print $1}`

**示例：**
```bash
awk '{print $1, $3}' file.txt
awk -F: '{print $1}' /etc/passwd
awk '$3 > 1000 {print $1, $3}' /etc/passwd
awk '{sum += $2} END {print sum}' data.txt
```

#### 简单 awk 脚本示例

统计日志中每种错误出现次数：
```bash
awk '/error/ {count[$2]++} END {for (k in count) print k, count[k]}' logfile
```

---

## 模式匹配与正则表达式

正则表达式（Regular Expression）用于描述字符串匹配规则，是 grep、sed、awk 等文本工具的核心。

### 基本正则符号

| 符号   | 含义                   |
|--------|------------------------|
| .      | 匹配任意单个字符       |
| ^      | 匹配行首               |
| $      | 匹配行尾               |
| *      | 匹配前一个字符0次或多次 |
| +      | 匹配前一个字符1次或多次 |
| ?      | 匹配前一个字符0次或1次  |
| []     | 匹配集合内任一字符      |
| [^ ]   | 匹配集合外任一字符      |
| \|     | 或（在egrep/awk中）     |
| ()     | 分组                   |

### grep 中的正则

- 匹配以 error 开头的行：
  ```bash
  grep "^error" file.txt
  ```
- 匹配以 .log 结尾的文件名：
  ```bash
  grep "\.log$" filelist.txt
  ```
- 匹配包含数字的行：
  ```bash
  grep "[0-9]" file.txt
  ```

### sed 中的正则

- 删除空行：
  ```bash
  sed '/^$/d' file.txt
  ```
- 替换所有数字为 X：
  ```bash
  sed 's/[0-9]/X/g' file.txt
  ```

### awk 中的正则

- 匹配包含 error 的行：
  ```bash
  awk '/error/' file.txt
  ```
- 匹配第1列为数字的行：
  ```bash
  awk '$1 ~ /^[0-9]+$/' file.txt
  ```

---

## 文件与内容查找工具

### find

在目录树中查找文件，支持按名称、类型、大小、时间等多种条件。

```bash
find [路径] [条件] [操作]
```
常用条件：
- `-name`：按名称查找（支持通配符）
- `-type`：按类型查找（f 文件，d 目录，l 链接）
- `-size`：按大小查找
- `-mtime`：按修改时间查找
- `-user`：按属主查找

常用操作：
- `-exec`：对查找到的文件执行命令
- `-delete`：直接删除

示例：
```bash
find /var/log -name "*.log"
find . -type f -size +100M
find /home -mtime -1
find /tmp -type f -name "*.tmp" -delete
find . -type f -exec grep -H "pattern" {} \;
```

---

### locate

基于数据库的快速文件查找工具（需定期更新数据库）。

```bash
locate 文件名
```
示例：
```bash
locate sshd_config
```

---

### xargs

将标准输入转为命令参数，常与 find、grep 等结合使用。

示例：
```bash
find . -name "*.log" | xargs grep "error"
```

---

### sort、uniq、cut、head、tail

- **sort**：排序
  ```bash
  sort file.txt
  ```
- **uniq**：去重（常与 sort 配合）
  ```bash
  sort file.txt | uniq
  ```
- **cut**：按列提取
  ```bash
  cut -d: -f1 /etc/passwd
  ```
- **head/tail**：显示文件开头/结尾
  ```bash
  head -n 10 file.txt
  tail -f /var/log/syslog
  ```

---

## 运维常见日志处理举例

- 查看最近的错误日志：
  ```bash
  tail -n 100 /var/log/syslog | grep "error"
  ```
- 统计某类日志出现次数：
  ```bash
  grep "timeout" /var/log/nginx/access.log | wc -l
  ```
- 批量替换配置文件内容：
  ```bash
  find . -type f -name "*.conf" -exec sed -i 's/old/new/g' {} +
  ```
- 统计访问最多的IP：
  ```bash
  awk '{print $1}' access.log | sort | uniq -c | sort -nr | head
  ```

---

> 熟练掌握这些文本处理和查找工具，可以极大提升 Linux 下日志分析、批量处理和日常运维的效率